// prisma/schema.prisma

generator client {
  provider     = "prisma-client"
  output       = "../src/generated/prisma"
  engineType   = "client"      // Rust-free Prisma Client
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String    @id @default(uuid())
  clerkId   String    @unique
  email     String    @unique
  username  String?    @unique
  imageUrl  String
  firstName String
  lastName  String
  isOnline  Boolean @default(false)
  createdAt DateTime  @default(now())
  role  Role  @default(USER)

  chatUsers ChatUser[]
  chatAdmins Chat[] @relation("groupAdmin")

  messages  Message[]
}

model Chat{
  id String @id @default(uuid())
  createdAt DateTime @default(now())
  chatType ChatType @default(DM)
  status ChatStatus @default(INVITED)

  // For DM
  dmKey String? @unique
  invitedByUserId String?

  groupIcon String?
  groupName String?

  groupAdmin User? @relation("groupAdmin", fields: [groupAdminUserId], references: [id])
  groupAdminUserId String?

  messages Message[]
  chatUsers ChatUser[]
}

model ChatUser{
  id String @id @default(uuid())
  role ChatUserType @default(MEMBER)

  status ChatUserStatus @default(PENDING)

  lastReadAt DateTime?
  joinedAt DateTime @default(now())
  leftAt DateTime?

  user User @relation(fields: [userId], references: [id])
  userId String

  chat Chat @relation(fields: [chatId], references: [id])
  chatId String

  @@unique([userId, chatId])
}

model Message {
  id        String    @id @default(uuid())
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
  userId String

  chat Chat @relation(fields: [chatId], references: [id])
  chatId String
}

enum Role{
  USER
  ADMIN
}

enum ChatType{
  DM
  GROUP
}

enum ChatUserType{
  ADMIN
  MEMBER
}

enum ChatStatus{
  INVITED
  ACTIVE
  DECLINED
}

enum ChatUserStatus{
  PENDING
  ACCEPTED
  DECLINED
}